rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() { 
      return isSignedIn() && (
        request.auth.token.role == 'admin' || 
        request.auth.token.email.matches('.*@hitam\\.org$')
      );
    }
    function isStudent() { 
      return isSignedIn() && (
        request.auth.token.role == 'student' || 
        request.auth.token.email.matches('.*@hitam\\.org$')
      );
    }
    function isSelf(uid) { return isSignedIn() && request.auth.uid == uid; }

    // Users collection: students can read own, admins can read all. Admins set roles.
    match /users/{userId} {
      allow read: if isSelf(userId) || isAdmin();
      allow create: if isSignedIn() && isSelf(userId);
      allow update: if (isAdmin()) || (isSelf(userId) && !("role" in request.resource.data.diff(resource.data).changedKeys()));
      allow delete: if isAdmin();
    }

    // Menu: readable by all signed-in, writable by admins only
    match /menu/{itemId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // User cart subcollection
    match /users/{userId}/cart/{itemId} {
      allow read, create, update, delete: if isSelf(userId) || isAdmin();
    }

    // Orders: students create for themselves; admins manage all
    match /orders/{orderId} {
      allow read: if isAdmin() || (isStudent() && resource.data.userId == request.auth.uid);
      allow create: if isStudent() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (isStudent() && request.auth.uid == resource.data.userId &&
        request.resource.data.status == resource.data.status);
      allow delete: if isAdmin();

      // Basic schema checks
      allow create, update: if request.resource.data.keys().hasAll(['userId','items','status','createdAt','totalPrice']) &&
        request.resource.data.status in ['Pending','Preparing','Ready for Pickup','Completed','Cancelled'] &&
        request.resource.data.items.size() > 0 &&
        request.resource.data.totalPrice is number;
    }
  }
}


